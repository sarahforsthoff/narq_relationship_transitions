---
title: "03_dataanalyses"
output: html_document
editor_options: 
  chunk_output_type: console
---

## TODO before
- Analysis with quartiles
- check analyses if controlling for quartile 

- plot quartiles

- plot extreme groups

- plot relative hazard

- analyses including future prospects

## Planned Analysis:
### Relationship Entry
- Model 1: rel_entry ~ NARQ + cluster(session)
- Model 2: rel_entry ~ NARQ_ADM + NARQ_RIV + cluster(session)
- Model 3: rel_entry ~ NARQ_ADM + NARQ_RIV + gender/sex + age + cluster(session)
### Relationship End
- Model 1: rel_end ~ NARQ + cluster(session)
- Model 2: rel_end ~ NARQ_ADM + NARQ_RIV + cluster(session)
- Model 3: rel_end ~ NARQ_ADM + NARQ_RIV + gender/sex + age + cluster(session)

## Packages
```{r}
library(lm.beta)
library(survival)
library(coxme)
library(survminer)
library(formr)
library(dplyr)
select = dplyr::select
```

## Data
```{r}
surv_data = read.csv("ImportedData/data_exclusive_clean.csv")
```

## Clean Data
```{r}
#Exlude sex == 3
surv_data = surv_data %>%
  filter(sex != 3)
```


### Preperations before analyses
Time of relationship/being single has to be in days
```{r}
surv_data = surv_data %>%
  mutate(single_start = as.Date(single_start),
         single_end = as.Date(single_end),
         start = as.Date(start),
         end = as.Date(end),
         single_start_d = 0,
         single_end_d = single_end - single_start,
         rel_start_d = 0,
         rel_end_d = end - start)


surv_data = surv_data %>%
  mutate(NARQ_scale_z = as.numeric(scale(NARQ_scale, center = T, scale = T)),
         NARQ_ADM_z = as.numeric(scale(NARQ_ADM, center = T, scale = T)),
         NARQ_RIV_z = as.numeric(scale(NARQ_RIV, center = T, scale = T)))




```

# Continous NARQ
##Relationship start
- Model 1: rel_entry ~ NARQ + cluster(session)
- Model 2: rel_entry ~ NARQ_ADM + NARQ_RIV + cluster(session)
- Model 3: rel_entry ~ NARQ_ADM + NARQ_RIV + gender/sex + age + cluster(session)

###Raw NARQ Data
```{r}
start_narq_con.1 <- coxph(Surv(single_start_d, single_end_d, event_start) ~ 
                            NARQ_scale + cluster(session), data = surv_data)



summary(start_narq_con.1)
plot(survfit(start_narq_con.1))

## Should not be significant
cox.zph(start_narq_con.1)
testPH_start_narq_con.1 <- ggcoxzph(cox.zph(start_narq_con.1))





start_narq_con.2 <- coxph(Surv(single_start_d, single_end_d, event_start) ~ 
                            NARQ_ADM + NARQ_RIV + cluster(session), data = surv_data)
summary(start_narq_con.2)
plot(survfit(start_narq_con.2))
## Should not be significant
cox.zph(start_narq_con.2)
testPH_start_narq_con.2 <- ggcoxzph(cox.zph(start_narq_con.2))




start_narq_con.3 <- coxph(Surv(single_start_d, single_end_d, event_start) ~ 
                            NARQ_ADM + NARQ_RIV + sex + age + cluster(session),
                          data = surv_data)
summary(start_narq_con.3)
plot(survfit(start_narq_con.3))
## Should not be significant
cox.zph(start_narq_con.3)
testPH_start_narq_con.3 <- ggcoxzph(cox.zph(start_narq_con.3))



############# Plotting Method by cox guy

#tfit <- coxph(Surv(time, status) ~ pspline(pat.karno) + sex + age, lung)
#termplot(tfit, term=1, se=T)

test <-  coxph(Surv(single_start_d, single_end_d, event_start) ~ 
                            pspline(NARQ_ADM) + NARQ_RIV + sex + age + cluster(session),
                          data = surv_data)
summary(test)
termplot(test, term = 1, se = T)

test2 <- coxph(Surv(single_start_d, single_end_d, event_start) ~ 
                            NARQ_ADM + pspline(NARQ_RIV) + sex + age + cluster(session),
                          data = surv_data)
summary(test2)
termplot(test2, term = 2, se = T)

```




###Standardized NARQ Data
```{r}
start_narq_con.1 <- coxph(Surv(single_start_d, single_end_d, event_start) ~ 
                            NARQ_scale_z + cluster(session), data = surv_data)



summary(start_narq_con.1)
plot(survfit(start_narq_con.1))

## Should not be significant
cox.zph(start_narq_con.1)
testPH_start_narq_con.1 <- ggcoxzph(cox.zph(start_narq_con.1))





start_narq_con.2 <- coxph(Surv(single_start_d, single_end_d, event_start) ~ 
                            NARQ_ADM_z + NARQ_RIV_z + cluster(session), data = surv_data)
summary(start_narq_con.2)
plot(survfit(start_narq_con.2))
## Should not be significant
cox.zph(start_narq_con.2)
testPH_start_narq_con.2 <- ggcoxzph(cox.zph(start_narq_con.2))




start_narq_con.3 <- coxph(Surv(single_start_d, single_end_d, event_start) ~ 
                            NARQ_ADM_z + NARQ_RIV_z + sex + age + cluster(session),
                          data = surv_data)
summary(start_narq_con.3)
plot(survfit(start_narq_con.3))
## Should not be significant
cox.zph(start_narq_con.3)
testPH_start_narq_con.3 <- ggcoxzph(cox.zph(start_narq_con.3))
```


##Relationship end
- Model 1: rel_end ~ NARQ + cluster(session)
- Model 2: rel_end ~ NARQ_ADM + NARQ_RIV + cluster(session)
- Model 3: rel_end ~ NARQ_ADM + NARQ_RIV + gender/sex + age + cluster(session)

###Raw NARQ Data
```{r}
start_narq_con.1 <- coxph(Surv(rel_start_d, rel_end_d, event_end) ~ 
                            NARQ_scale + cluster(session), data = surv_data)



summary(start_narq_con.1)
plot(survfit(start_narq_con.1))

## Should not be significant
cox.zph(start_narq_con.1)
testPH_start_narq_con.1 <- ggcoxzph(cox.zph(start_narq_con.1))





start_narq_con.2 <- coxph(Surv(rel_start_d, rel_end_d, event_end) ~ 
                            NARQ_ADM + NARQ_RIV + cluster(session), data = surv_data)
summary(start_narq_con.2)
plot(survfit(start_narq_con.2))
## Should not be significant
cox.zph(start_narq_con.2)
testPH_start_narq_con.2 <- ggcoxzph(cox.zph(start_narq_con.2))




start_narq_con.3 <- coxph(Surv(rel_start_d, rel_end_d, event_end) ~ 
                            NARQ_ADM + NARQ_RIV + sex + age + cluster(session),
                          data = surv_data)
summary(start_narq_con.3)
plot(survfit(start_narq_con.3))
## Should not be significant
cox.zph(start_narq_con.3)
testPH_start_narq_con.3 <- ggcoxzph(cox.zph(start_narq_con.3))


```


###Standardized NARQ Data
```{r}
start_narq_con.1 <- coxph(Surv(rel_start_d, rel_end_d, event_end) ~ 
                            NARQ_scale_z + cluster(session), data = surv_data)



summary(start_narq_con.1)
plot(survfit(start_narq_con.1))

## Should not be significant
cox.zph(start_narq_con.1)
testPH_start_narq_con.1 <- ggcoxzph(cox.zph(start_narq_con.1))





start_narq_con.2 <- coxph(Surv(rel_start_d, rel_end_d, event_end) ~ 
                            NARQ_ADM_z + NARQ_RIV_z + cluster(session), data = surv_data)
summary(start_narq_con.2)
plot(survfit(start_narq_con.2))
## Should not be significant
cox.zph(start_narq_con.2)
testPH_start_narq_con.2 <- ggcoxzph(cox.zph(start_narq_con.2))




start_narq_con.3 <- coxph(Surv(rel_start_d, rel_end_d, event_end) ~ 
                            NARQ_ADM_z + NARQ_RIV_z + sex + age + cluster(session),
                          data = surv_data)
summary(start_narq_con.3)
plot(survfit(start_narq_con.3))
## Should not be significant
cox.zph(start_narq_con.3)
testPH_start_narq_con.3 <- ggcoxzph(cox.zph(start_narq_con.3))
```





# Categorical NARQ
```{r}
#NARQ_scale
median_NARQ_scale = median(surv_data$NARQ_scale, na.rm = T)
surv_data = surv_data %>%
  mutate(NARQ_group = ifelse(NARQ_scale <= median_NARQ_scale, "low", 
                             ifelse(is.na(NARQ_scale), NA, "high")),
         NARQ_group = as.factor(NARQ_group))

#NARQ_ADM
median_NARQ_ADM = median(surv_data$NARQ_ADM, na.rm = T)
surv_data = surv_data %>%
  mutate(NARQ_ADM_group = ifelse(NARQ_ADM <= median_NARQ_ADM, "low", 
                             ifelse(is.na(NARQ_ADM), NA, "high")),
         NARQ_ADM_group = as.factor(NARQ_ADM_group))

#NARQ_RIV
median_NARQ_RIV = median(surv_data$NARQ_RIV, na.rm = T)
surv_data = surv_data %>%
  mutate(NARQ_RIV_group = ifelse(NARQ_RIV <= median_NARQ_RIV, "low", 
                             ifelse(is.na(NARQ_RIV), NA, "high")),
         NARQ_RIV_group = as.factor(NARQ_RIV_group))

```


##Relationship start
- Model 1: rel_entry ~ NARQ_group + cluster(session)
- Model 2: rel_entry ~ NARQ_ADM_group + NARQ_RIV_group + cluster(session)
- Model 3: rel_entry ~ NARQ_ADM_group + NARQ_RIV_group + gender/sex + age + cluster(session)

###Raw NARQ Data
```{r}
start_narq_con.1 <- coxph(Surv(single_start_d, single_end_d, event_start) ~ 
                            NARQ_group + cluster(session), data = surv_data)



summary(start_narq_con.1)
plot(survfit(start_narq_con.1))

## Should not be significant
cox.zph(start_narq_con.1)
testPH_start_narq_con.1 <- ggcoxzph(cox.zph(start_narq_con.1))





start_narq_con.2 <- coxph(Surv(single_start_d, single_end_d, event_start) ~ 
                            NARQ_ADM_group + NARQ_RIV_group + cluster(session), data = surv_data)
summary(start_narq_con.2)
plot(survfit(start_narq_con.2))
## Should not be significant
cox.zph(start_narq_con.2)
testPH_start_narq_con.2 <- ggcoxzph(cox.zph(start_narq_con.2))




start_narq_con.3 <- coxph(Surv(single_start_d, single_end_d, event_start) ~ 
                            NARQ_ADM_group + NARQ_RIV_group + sex + age + cluster(session),
                          data = surv_data)
summary(start_narq_con.3)
plot(survfit(start_narq_con.3))
## Should not be significant
cox.zph(start_narq_con.3)
testPH_start_narq_con.3 <- ggcoxzph(cox.zph(start_narq_con.3))


```



##Relationship end
- Model 1: rel_end ~ NARQ_group + cluster(session)
- Model 2: rel_end ~ NARQ_ADM_group + NARQ_RIV_group + cluster(session)
- Model 3: rel_end ~ NARQ_ADM_group + NARQ_RIV_group + gender/sex + age + cluster(session)

###Raw NARQ Data
```{r}
start_narq_con.1 <- coxph(Surv(rel_start_d, rel_end_d, event_end) ~ 
                            NARQ_group + cluster(session), data = surv_data)



summary(start_narq_con.1)
plot(survfit(start_narq_con.1))

## Should not be significant
cox.zph(start_narq_con.1)
testPH_start_narq_con.1 <- ggcoxzph(cox.zph(start_narq_con.1))





start_narq_con.2 <- coxph(Surv(rel_start_d, rel_end_d, event_end) ~ 
                            NARQ_ADM_group + NARQ_RIV_group + cluster(session), data = surv_data)
summary(start_narq_con.2)
plot(survfit(start_narq_con.2))
## Should not be significant
cox.zph(start_narq_con.2)
testPH_start_narq_con.2 <- ggcoxzph(cox.zph(start_narq_con.2))




start_narq_con.3 <- coxph(Surv(rel_start_d, rel_end_d, event_end) ~ 
                            NARQ_ADM_group + NARQ_RIV_group + sex + age + cluster(session),
                          data = surv_data)
summary(start_narq_con.3)
plot(survfit(start_narq_con.3))
## Should not be significant
cox.zph(start_narq_con.3)
testPH_start_narq_con.3 <- ggcoxzph(cox.zph(start_narq_con.3))
```

## Plots
```{r}
plot_model1 = survfit(Surv(single_start_d, single_end_d, event_start) ~ 
                            NARQ_ADM_group,
                          data = surv_data)
ggsurvplot(plot_model1, data = surv_data, conf.int = T)

plot_model2 = survfit(Surv(rel_start_d, rel_end_d, event_end) ~ 
                            NARQ_ADM_group + NARQ_RIV_group + sex + age + cluster(session),
                          data = surv_data)
ggsurvplot(plot_model2, data = surv_data, conf.int = T)
```
















```{r}
start_narq_gr.1 <- coxph(Surv(single_start_d, relationship_start_d, event) ~ 
                            NARQ_group + cluster(session), data= surv_data)
summary(start_narq_gr.1)
plot(survfit(start_narq_gr.1))

start_narq_gr.2 <-  coxph(Surv(single_start_d, relationship_start_d, event) ~ 
                            NARQ_ADM_group + NARQ_RIV_group + cluster(session), data= surv_data)
summary(start_narq_gr.2)
plot(survfit(start_narq_gr.2))

start_narq_gr.3 <-  coxph(Surv(single_start_d, relationship_start_d, event) ~ 
                            NARQ_ADM_group + NARQ_RIV_group + sex + age + cluster(session), data= surv_data)
summary(start_narq_gr.3)
plot(survfit(start_narq_gr.3))
```


