---
title: "03_dataanalyses"
output: html_document
editor_options: 
  chunk_output_type: console
---

## TODO before
- Plot quartile, plot extreme groups, plot relative hazard (control!)
- check analyses if controlling for quartile 
- analyses with future prospects

## Planned Analysis:
### Relationship Entry
- Model 1: rel_entry ~ NARQ + cluster(session)
- Model 2: rel_entry ~ NARQ_ADM + NARQ_RIV + cluster(session)
- Model 3: rel_entry ~ NARQ_ADM + NARQ_RIV + gender/sex + age + cluster(session)
### Relationship End
- Model 1: rel_end ~ NARQ + cluster(session)
- Model 2: rel_end ~ NARQ_ADM + NARQ_RIV + cluster(session)
- Model 3: rel_end ~ NARQ_ADM + NARQ_RIV + gender/sex + age + cluster(session)

## Packages
```{r}
library(lm.beta)
library(survival)
library(coxme)
library(survminer)
library(formr)
library(dplyr)
select = dplyr::select
```

## Data
```{r}
surv_data = read.csv("ImportedData/data_exclusive_clean.csv")
```

## Clean Data
```{r}
#Exlude sex == 3
surv_data = surv_data %>%
  filter(sex != 3)
```


### Preperations before analyses
Time of relationship/being single has to be in days
```{r}
surv_data = surv_data %>%
  mutate(single_start = as.Date(single_start),
         single_end = as.Date(single_end),
         start = as.Date(start),
         end = as.Date(end),
         single_start_d = 0,
         single_end_d = single_end - single_start,
         rel_start_d = 0,
         rel_end_d = end - start)


surv_data = surv_data %>%
  mutate(NARQ_scale_z = as.numeric(scale(NARQ_scale, center = T, scale = T)),
         NARQ_ADM_z = as.numeric(scale(NARQ_ADM, center = T, scale = T)),
         NARQ_RIV_z = as.numeric(scale(NARQ_RIV, center = T, scale = T)))




```

# Continous NARQ
##Relationship start
- Model 1: rel_entry ~ NARQ + cluster(session)
- Model 2: rel_entry ~ NARQ_ADM + NARQ_RIV + cluster(session)
- Model 3: rel_entry ~ NARQ_ADM + NARQ_RIV + gender/sex + age + cluster(session)

###Raw NARQ Data
```{r}
start_narq_con.1 <- coxph(Surv(single_start_d, single_end_d, event_start) ~ 
                            NARQ_scale + cluster(session), data = surv_data)



summary(start_narq_con.1)
plot(survfit(start_narq_con.1))

## Should not be significant
cox.zph(start_narq_con.1)
testPH_start_narq_con.1 <- ggcoxzph(cox.zph(start_narq_con.1))





start_narq_con.2 <- coxph(Surv(single_start_d, single_end_d, event_start) ~ 
                            NARQ_ADM + NARQ_RIV + cluster(session), data = surv_data)
summary(start_narq_con.2)
plot(survfit(start_narq_con.2))
## Should not be significant
cox.zph(start_narq_con.2)
testPH_start_narq_con.2 <- ggcoxzph(cox.zph(start_narq_con.2))




start_narq_con.3 <- coxph(Surv(single_start_d, single_end_d, event_start) ~ 
                            NARQ_ADM + NARQ_RIV + sex + age + cluster(session),
                          data = surv_data)
summary(start_narq_con.3)
plot(survfit(start_narq_con.3))
## Should not be significant
cox.zph(start_narq_con.3)
testPH_start_narq_con.3 <- ggcoxzph(cox.zph(start_narq_con.3))


```


###Standardized NARQ Data
```{r}
start_narq_con.1 <- coxph(Surv(single_start_d, single_end_d, event_start) ~ 
                            NARQ_scale_z + cluster(session), data = surv_data)



summary(start_narq_con.1)
plot(survfit(start_narq_con.1))

## Should not be significant
cox.zph(start_narq_con.1)
testPH_start_narq_con.1 <- ggcoxzph(cox.zph(start_narq_con.1))





start_narq_con.2 <- coxph(Surv(single_start_d, single_end_d, event_start) ~ 
                            NARQ_ADM_z + NARQ_RIV_z + cluster(session), data = surv_data)
summary(start_narq_con.2)
plot(survfit(start_narq_con.2))
## Should not be significant
cox.zph(start_narq_con.2)
testPH_start_narq_con.2 <- ggcoxzph(cox.zph(start_narq_con.2))




start_narq_con.3 <- coxph(Surv(single_start_d, single_end_d, event_start) ~ 
                            NARQ_ADM_z + NARQ_RIV_z + sex + age + cluster(session),
                          data = surv_data)
summary(start_narq_con.3)
plot(survfit(start_narq_con.3))
## Should not be significant
cox.zph(start_narq_con.3)
testPH_start_narq_con.3 <- ggcoxzph(cox.zph(start_narq_con.3))
```


##Relationship end
- Model 1: rel_end ~ NARQ + cluster(session)
- Model 2: rel_end ~ NARQ_ADM + NARQ_RIV + cluster(session)
- Model 3: rel_end ~ NARQ_ADM + NARQ_RIV + gender/sex + age + cluster(session)

###Raw NARQ Data
```{r}
start_narq_con.1 <- coxph(Surv(rel_start_d, rel_end_d, event_end) ~ 
                            NARQ_scale + cluster(session), data = surv_data)



summary(start_narq_con.1)
plot(survfit(start_narq_con.1))

## Should not be significant
cox.zph(start_narq_con.1)
testPH_start_narq_con.1 <- ggcoxzph(cox.zph(start_narq_con.1))





start_narq_con.2 <- coxph(Surv(rel_start_d, rel_end_d, event_end) ~ 
                            NARQ_ADM + NARQ_RIV + cluster(session), data = surv_data)
summary(start_narq_con.2)
plot(survfit(start_narq_con.2))
## Should not be significant
cox.zph(start_narq_con.2)
testPH_start_narq_con.2 <- ggcoxzph(cox.zph(start_narq_con.2))




start_narq_con.3 <- coxph(Surv(rel_start_d, rel_end_d, event_end) ~ 
                            NARQ_ADM + NARQ_RIV + sex + age + cluster(session),
                          data = surv_data)
summary(start_narq_con.3)
plot(survfit(start_narq_con.3))
## Should not be significant
cox.zph(start_narq_con.3)
testPH_start_narq_con.3 <- ggcoxzph(cox.zph(start_narq_con.3))


```


###Standardized NARQ Data
```{r}
start_narq_con.1 <- coxph(Surv(rel_start_d, rel_end_d, event_end) ~ 
                            NARQ_scale_z + cluster(session), data = surv_data)



summary(start_narq_con.1)
plot(survfit(start_narq_con.1))

## Should not be significant
cox.zph(start_narq_con.1)
testPH_start_narq_con.1 <- ggcoxzph(cox.zph(start_narq_con.1))





start_narq_con.2 <- coxph(Surv(rel_start_d, rel_end_d, event_end) ~ 
                            NARQ_ADM_z + NARQ_RIV_z + cluster(session), data = surv_data)
summary(start_narq_con.2)
plot(survfit(start_narq_con.2))
## Should not be significant
cox.zph(start_narq_con.2)
testPH_start_narq_con.2 <- ggcoxzph(cox.zph(start_narq_con.2))




start_narq_con.3 <- coxph(Surv(rel_start_d, rel_end_d, event_end) ~ 
                            NARQ_ADM_z + NARQ_RIV_z + sex + age + cluster(session),
                          data = surv_data)
summary(start_narq_con.3)
plot(survfit(start_narq_con.3))
## Should not be significant
cox.zph(start_narq_con.3)
testPH_start_narq_con.3 <- ggcoxzph(cox.zph(start_narq_con.3))
```





# Categorical NARQ
```{r}
#NARQ_scale
median_NARQ_scale = median(surv_data$NARQ_scale, na.rm = T)
surv_data = surv_data %>%
  mutate(NARQ_group = ifelse(NARQ_scale <= median_NARQ_scale, "low", 
                             ifelse(is.na(NARQ_scale), NA, "high")),
         NARQ_group = as.factor(NARQ_group))

#NARQ_ADM
median_NARQ_ADM = median(surv_data$NARQ_ADM, na.rm = T)
surv_data = surv_data %>%
  mutate(NARQ_ADM_group = ifelse(NARQ_ADM <= median_NARQ_ADM, "low", 
                             ifelse(is.na(NARQ_ADM), NA, "high")),
         NARQ_ADM_group = as.factor(NARQ_ADM_group))

#NARQ_RIV
median_NARQ_RIV = median(surv_data$NARQ_RIV, na.rm = T)
surv_data = surv_data %>%
  mutate(NARQ_RIV_group = ifelse(NARQ_RIV <= median_NARQ_RIV, "low", 
                             ifelse(is.na(NARQ_RIV), NA, "high")),
         NARQ_RIV_group = as.factor(NARQ_RIV_group))

```


##Relationship start
- Model 1: rel_entry ~ NARQ_group + cluster(session)
- Model 2: rel_entry ~ NARQ_ADM_group + NARQ_RIV_group + cluster(session)
- Model 3: rel_entry ~ NARQ_ADM_group + NARQ_RIV_group + gender/sex + age + cluster(session)

###Raw NARQ Data
```{r}
start_narq_con.1 <- coxph(Surv(single_start_d, single_end_d, event_start) ~ 
                            NARQ_group + cluster(session), data = surv_data)



summary(start_narq_con.1)
plot(survfit(start_narq_con.1))

## Should not be significant
cox.zph(start_narq_con.1)
testPH_start_narq_con.1 <- ggcoxzph(cox.zph(start_narq_con.1))





start_narq_con.2 <- coxph(Surv(single_start_d, single_end_d, event_start) ~ 
                            NARQ_ADM_group + NARQ_RIV_group + cluster(session), data = surv_data)
summary(start_narq_con.2)
plot(survfit(start_narq_con.2))
## Should not be significant
cox.zph(start_narq_con.2)
testPH_start_narq_con.2 <- ggcoxzph(cox.zph(start_narq_con.2))




start_narq_con.3 <- coxph(Surv(single_start_d, single_end_d, event_start) ~ 
                            NARQ_ADM_group + NARQ_RIV_group + sex + age + cluster(session),
                          data = surv_data)
summary(start_narq_con.3)
plot(survfit(start_narq_con.3))
## Should not be significant
cox.zph(start_narq_con.3)
testPH_start_narq_con.3 <- ggcoxzph(cox.zph(start_narq_con.3))


```



##Relationship end
- Model 1: rel_end ~ NARQ_group + cluster(session)
- Model 2: rel_end ~ NARQ_ADM_group + NARQ_RIV_group + cluster(session)
- Model 3: rel_end ~ NARQ_ADM_group + NARQ_RIV_group + gender/sex + age + cluster(session)

###Raw NARQ Data
```{r}
start_narq_con.1 <- coxph(Surv(rel_start_d, rel_end_d, event_end) ~ 
                            NARQ_group + cluster(session), data = surv_data)



summary(start_narq_con.1)
plot(survfit(start_narq_con.1))

## Should not be significant
cox.zph(start_narq_con.1)
testPH_start_narq_con.1 <- ggcoxzph(cox.zph(start_narq_con.1))





start_narq_con.2 <- coxph(Surv(rel_start_d, rel_end_d, event_end) ~ 
                            NARQ_ADM_group + NARQ_RIV_group + cluster(session), data = surv_data)
summary(start_narq_con.2)
plot(survfit(start_narq_con.2))
## Should not be significant
cox.zph(start_narq_con.2)
testPH_start_narq_con.2 <- ggcoxzph(cox.zph(start_narq_con.2))




start_narq_con.3 <- coxph(Surv(rel_start_d, rel_end_d, event_end) ~ 
                            NARQ_ADM_group + NARQ_RIV_group + sex + age + cluster(session),
                          data = surv_data)
summary(start_narq_con.3)
plot(survfit(start_narq_con.3))
## Should not be significant
cox.zph(start_narq_con.3)
testPH_start_narq_con.3 <- ggcoxzph(cox.zph(start_narq_con.3))
```

## Plots
```{r}
plot_model1 = survfit(Surv(single_start_d, single_end_d, event_start) ~ 
                            NARQ_ADM_group,
                          data = surv_data)
ggsurvplot(plot_model1, data = surv_data, conf.int = T)

plot_model2 = survfit(Surv(rel_start_d, rel_end_d, event_end) ~ 
                            NARQ_ADM_group + NARQ_RIV_group + sex + age + cluster(session),
                          data = surv_data)
ggsurvplot(plot_model2, data = surv_data, conf.int = T)
```
















```{r}
start_narq_gr.1 <- coxph(Surv(single_start_d, relationship_start_d, event) ~ 
                            NARQ_group + cluster(session), data= surv_data)
summary(start_narq_gr.1)
plot(survfit(start_narq_gr.1))

start_narq_gr.2 <-  coxph(Surv(single_start_d, relationship_start_d, event) ~ 
                            NARQ_ADM_group + NARQ_RIV_group + cluster(session), data= surv_data)
summary(start_narq_gr.2)
plot(survfit(start_narq_gr.2))

start_narq_gr.3 <-  coxph(Surv(single_start_d, relationship_start_d, event) ~ 
                            NARQ_ADM_group + NARQ_RIV_group + sex + age + cluster(session), data= surv_data)
summary(start_narq_gr.3)
plot(survfit(start_narq_gr.3))
```


# Relationship End
- Model 1: rel_end ~ NARQ + cluster(session)
- Model 2: rel_end ~ NARQ_ADM + NARQ_RIV + cluster(session)
- Model 3: rel_end ~ NARQ_ADM + NARQ_RIV + gender/sex + age + cluster(session)

...to be continued...



#Test Analyses
Probably useless, I just did not want to delete them without looking at them together.


"m <- coxph(Surv(Single_Start, Beziehung_Start, Beziehung_event) ~ Age + Male + NARQ_Adm, data = testdata)"
summary(m)
plot(survfit(m))

```{r}

surv_data$sex <- factor(surv_data$sex, levels = c("1","2"))

x.1 <- coxph(Surv(single_start_d, relationship_start_d, event) ~ sex, data = surv_data)
summary(x.1)
plot(survfit(x.1), mark.time = T, col = c("blue","red"), conf.int = F)

x.2 <- coxph(Surv(single_start_d, relationship_start_d, event) ~ sex + cluster(session), data = surv_data)
summary(x.2)
plot(survfit(x.2), mark.time = T, col = c("blue","red"), conf.int = F)




y.1 <- survfit(Surv(single_start_d, relationship_start_d, event) ~ sex + cluster(session), data = surv_data)
summary(y.1)
plot(y.1, mark.time = T, col = c("blue","red"), conf.int = F)
ggsurvplot(y.1, data = surv_data, conf.int = T)

#age as a continuous variable only with coxph function 
y.2 <- coxph(Surv(single_start_d, relationship_start_d, event) ~ age + cluster(session), data = surv_data)
summary(y.2)
ggsurvplot(survfit(y.2), data = surv_data, conf.int = T)

median_NARQ_scale = median(surv_data$NARQ_scale, na.rm = T)

surv_data = surv_data %>%
  mutate(NARQ_group = ifelse(NARQ_scale <= median_NARQ_scale, "low", 
                             ifelse(is.na(NARQ_scale), NA, "high")))

y.3 <- survfit(Surv(single_start_d, relationship_start_d, event) ~ NARQ_group + cluster(session), data = surv_data)
summary(y.3)
ggsurvplot(y.3, data = surv_data, conf.int = T)


median_NARQ_ADM = median(surv_data$NARQ_ADM, na.rm = T)

surv_data = surv_data %>%
  mutate(NARQ_ADM_group = ifelse(NARQ_scale <= median_NARQ_ADM, "low", 
                             ifelse(is.na(NARQ_scale), NA, "high")))
                             

y.4 <- survfit(Surv(single_start_d, relationship_start_d, event) ~ NARQ_ADM_group + cluster(session), data = surv_data)
summary(y.4)
ggsurvplot(y.4, data = surv_data, conf.int = T)
                      
```



###Survival analyses of relationship transgression
  
```{r}

surv_data_rel$sex <- factor(surv_data_rel$sex, levels = c("1","2"))

a.1 <- coxph(Surv(relationship_start_d_end, relationship_end_d, event_end) ~ sex, data = surv_data_rel)
summary(a.1)
plot(survfit(a.1), mark.time = T, col = c("blue","red"), conf.int = F)

b.2 <- coxph(Surv(relationship_start_d_end, relationship_end_d, event_end) ~ sex + cluster(session), data = surv_data_rel)
summary(b.2)
plot(survfit(b.2), mark.time = T, col = c("blue","red"), conf.int = F)




```






###simulate data using proposed code
```{r}
########## simulate data ##########
set.seed(10)
N <- 250
dat <- data.frame(ID = factor(1:N), age = rnorm(N, mean = 45, sd = 5), sex = sample(0:1, 
    N, TRUE), basemort = rnorm(N, sd = 3))

interval <- matrix(sample(2:14, N * 3, replace = TRUE), N)
windows <- t(apply(cbind(0, interval), 1, cumsum))
windows <- rbind(windows[, 1:2], windows[, 2:3], windows[, 3:4])

colnames(windows) <- c("time1", "time2")
dat <- cbind(do.call(rbind, rep(list(dat), 3)), windows)
dat <- dat[order(dat$ID), ]
dat$assessment <- rep(1:3, N)
rownames(dat) <- NULL
head(dat)
##   ID  age sex basemort time1 time2 assessment
## 1  1 45.1   1    6.659     0    14          1
## 2  1 45.1   1    6.659    14    16          2
## 3  1 45.1   1    6.659    16    23          3
## 4  2 44.1   1    0.943     0     8          1
## 5  2 44.1   1    0.943     8    20          2
## 6  2 44.1   1    0.943    20    22          3
# simulate survival (mortality) data
transplant <- with(dat, {
    mu <- (0.05 * age) + (0.3 * time2)
    lp <- rnorm(N * 3, mean = mu, sd = 1)
    as.integer(lp > quantile(lp, probs = 0.65))
})
# ensure that transplants do not revert
transplant <- as.integer(ave(transplant, dat$ID, FUN = cumsum) >= 1)

# simulate survival (mortality) data
mortality <- with(dat, {
    mu <- basemort + (0.05 * age) - (2.5 * sex) + (0.3 * time2)
    lp <- rnorm(N * 3, mean = mu, sd = 1)
    as.integer(lp > median(lp))
})

# ensure that once someone dies, he or she stays dead
mortality <- as.integer(ave(mortality, dat$ID, FUN = cumsum) >= 1)

# ensure no one dead at baseline
mortality[dat$assessment == 1] <- 0

# ensure no post mortem change in transplant status
transplant <- unlist(by(data.frame(mortality, transplant), dat$ID, FUN = function(x) {
    i <- cumsum(x$mortality)
    tstat <- x$transplant[i == 1]
    x$transplant[i >= 1] <- tstat
    return(x$transplant)
}))

dat$transplant <- transplant
dat$mortality <- mortality

# print first few rows
head(dat)
```

```{r}
########## basic models ########## simple model
m <- coxph(Surv(time1, time2, mortality) ~ age + sex + transplant, data = dat)
## summary of the model
summary(m)
plot(survfit(m))
```


```{r}
## model with robust SE via clustering
m2 <- coxph(Surv(time1, time2, mortality) ~ age + sex + transplant + cluster(ID), 
    data = dat)
## summary of the model
summary(m2)
plot(survfit(m2))
```

###Test function with our own test data
```{r}
testdata <- read.csv("C:/Users/q/Desktop/Speicherung/Arbeit/3/Narc_Relationship/narq_relationship_transitions/testdata.csv")


########## basic models ########## simple model
m <- coxph(Surv(Single_Start, Beziehung_Start, Beziehung_event) ~ Age + Male + NARQ_Adm, data = testdata)
## summary of the model
summary(m)
plot(survfit(m))

####model with robust SE via clustering
 
m <- coxph(Surv(Single_Start, Beziehung_Start, Beziehung_event) ~ Age + Male + NARQ_Adm + cluster(Session_Code),
           data = testdata)
## summary of the model


summary(m)
plot(m)
```


