---
title: "03_dataanalyses"
output: html_document
editor_options: 
  chunk_output_type: console
---

Why are there n = 34 for which single_start > single_end???

## TODO before
DONE(- Analysis with quartiles) --> Rename models!!!
- check analyses if controlling for quartile 

DONE(- plot quartiles)

- plot extreme groups
    *Extreme groups: Mean +- SD
    *Plot subgroups with ggsurvplot_list()
    *How to specifiy extreme groups though with list()-function?

Example(- plot relative hazard) --> s. below


- analyses including future prospects

## Planned Analysis:
### Relationship Entry
- Model 1: rel_entry ~ NARQ + cluster(session)
- Model 2: rel_entry ~ NARQ_ADM + NARQ_RIV + cluster(session)
- Model 3: rel_entry ~ NARQ_ADM + NARQ_RIV + gender/sex + age + cluster(session)
### Relationship End
- Model 1: rel_end ~ NARQ + cluster(session)
- Model 2: rel_end ~ NARQ_ADM + NARQ_RIV + cluster(session)
- Model 3: rel_end ~ NARQ_ADM + NARQ_RIV + gender/sex + age + cluster(session)

## Packages
```{r}
library(lm.beta)
library(survival)
library(coxme)
library(survminer)
library(formr)
library(dplyr)
select = dplyr::select
```

## Data
```{r}
surv_data = read.csv("ImportedData/data_exclusive_clean.csv")

```


### Preperations before analyses
Time of relationship/being single has to be in days
```{r}
surv_data = surv_data %>%
  mutate(single_start = as.Date(single_start),
         single_end = as.Date(single_end),
         start = as.Date(start),
         end = as.Date(end),
         single_start_d = 0,
         single_end_d = single_end - single_start,
         rel_start_d = 0,
         rel_end_d = end - start,
 single_end_d = ifelse(single_end_d == 0, 1, single_end_d), # two people started a new relationship at the same day they ended their old one, survival analyses can not believe that --> so we set it at 1 day)
  rel_end_d = ifelse(rel_end_d == 0, 1, rel_end_d)) # 27 people had started and filled out survey the same day (so right censored data) --> that's why we had to add 1 (day) to "rel_end_d"


surv_data = surv_data %>%
  mutate(NARQ_scale_z = as.numeric(scale(NARQ_scale, center = T, scale = T)),
         NARQ_ADM_z = as.numeric(scale(NARQ_ADM, center = T, scale = T)),
         NARQ_RIV_z = as.numeric(scale(NARQ_RIV, center = T, scale = T)))



```

# Continous NARQ
##Relationship start
- Model 1: rel_entry ~ NARQ + cluster(session)
- Model 2: rel_entry ~ NARQ_ADM + NARQ_RIV + cluster(session)
- Model 3: rel_entry ~ NARQ_ADM + NARQ_RIV + gender/sex + age + cluster(session)

###Raw NARQ Data
```{r}
start_narq_con.1 <- coxph(Surv(single_start_d, single_end_d, event_start) ~ 
                            NARQ_scale + cluster(session), data = surv_data)



summary(start_narq_con.1)
plot(survfit(start_narq_con.1))

## Should not be significant
cox.zph(start_narq_con.1)
testPH_start_narq_con.1 <- ggcoxzph(cox.zph(start_narq_con.1))





start_narq_con.2 <- coxph(Surv(single_start_d, single_end_d, event_start) ~ 
                            NARQ_ADM + NARQ_RIV + cluster(session), data = surv_data)
summary(start_narq_con.2)
plot(survfit(start_narq_con.2))
## Should not be significant
cox.zph(start_narq_con.2)
testPH_start_narq_con.2 <- ggcoxzph(cox.zph(start_narq_con.2))




start_narq_con.3 <- coxph(Surv(single_start_d, single_end_d, event_start) ~ 
                            NARQ_ADM + NARQ_RIV + sex + age + cluster(session),
                          data = surv_data)
summary(start_narq_con.3)
plot(survfit(start_narq_con.3))
## Should not be significant
cox.zph(start_narq_con.3)
testPH_start_narq_con.3 <- ggcoxzph(cox.zph(start_narq_con.3))



############# Plotting Method by cox guy

#tfit <- coxph(Surv(time, status) ~ pspline(pat.karno) + sex + age, lung)
#termplot(tfit, term=1, se=T)

test <-  coxph(Surv(single_start_d, single_end_d, event_start) ~ 
                            pspline(NARQ_ADM) + NARQ_RIV + sex + age + cluster(session),
                          data = surv_data)
summary(test)
termplot(test, term = 1, se = T)

test2 <- coxph(Surv(single_start_d, single_end_d, event_start) ~ 
                            NARQ_ADM + pspline(NARQ_RIV) + sex + age + cluster(session),
                          data = surv_data)
summary(test2)
termplot(test2, term = 2, se = T)

```




###Standardized NARQ Data
```{r}
start_narq_con.1 <- coxph(Surv(single_start_d, single_end_d, event_start) ~ 
                            NARQ_scale_z + cluster(session), data = surv_data)



summary(start_narq_con.1)
plot(survfit(start_narq_con.1))

## Should not be significant
cox.zph(start_narq_con.1)
testPH_start_narq_con.1 <- ggcoxzph(cox.zph(start_narq_con.1))





start_narq_con.2 <- coxph(Surv(single_start_d, single_end_d, event_start) ~ 
                            NARQ_ADM_z + NARQ_RIV_z + cluster(session), data = surv_data)
summary(start_narq_con.2)
plot(survfit(start_narq_con.2))
## Should not be significant
cox.zph(start_narq_con.2)
testPH_start_narq_con.2 <- ggcoxzph(cox.zph(start_narq_con.2))




start_narq_con.3 <- coxph(Surv(single_start_d, single_end_d, event_start) ~ 
                            NARQ_ADM_z + NARQ_RIV_z + sex + age + cluster(session),
                          data = surv_data)
summary(start_narq_con.3)
plot(survfit(start_narq_con.3))
## Should not be significant
cox.zph(start_narq_con.3)
testPH_start_narq_con.3 <- ggcoxzph(cox.zph(start_narq_con.3))
```


##Relationship end
- Model 1: rel_end ~ NARQ + cluster(session)
- Model 2: rel_end ~ NARQ_ADM + NARQ_RIV + cluster(session)
- Model 3: rel_end ~ NARQ_ADM + NARQ_RIV + gender/sex + age + cluster(session)

###Raw NARQ Data
```{r}
start_narq_con.1 <- coxph(Surv(rel_start_d, rel_end_d, event_end) ~ 
                            NARQ_scale + cluster(session), data = surv_data)



summary(start_narq_con.1)
plot(survfit(start_narq_con.1))

## Should not be significant
cox.zph(start_narq_con.1)
testPH_start_narq_con.1 <- ggcoxzph(cox.zph(start_narq_con.1))





start_narq_con.2 <- coxph(Surv(rel_start_d, rel_end_d, event_end) ~ 
                            NARQ_ADM + NARQ_RIV + cluster(session), data = surv_data)
summary(start_narq_con.2)
plot(survfit(start_narq_con.2))
## Should not be significant
cox.zph(start_narq_con.2)
testPH_start_narq_con.2 <- ggcoxzph(cox.zph(start_narq_con.2))




start_narq_con.3 <- coxph(Surv(rel_start_d, rel_end_d, event_end) ~ 
                            NARQ_ADM + NARQ_RIV + sex + age + cluster(session),
                          data = surv_data)
summary(start_narq_con.3)
plot(survfit(start_narq_con.3))
## Should not be significant
cox.zph(start_narq_con.3)
testPH_start_narq_con.3 <- ggcoxzph(cox.zph(start_narq_con.3))


```


###Standardized NARQ Data
```{r}
start_narq_con.1 <- coxph(Surv(rel_start_d, rel_end_d, event_end) ~ 
                            NARQ_scale_z + cluster(session), data = surv_data)



summary(start_narq_con.1)
plot(survfit(start_narq_con.1))

## Should not be significant
cox.zph(start_narq_con.1)
testPH_start_narq_con.1 <- ggcoxzph(cox.zph(start_narq_con.1))





start_narq_con.2 <- coxph(Surv(rel_start_d, rel_end_d, event_end) ~ 
                            NARQ_ADM_z + NARQ_RIV_z + cluster(session), data = surv_data)
summary(start_narq_con.2)
plot(survfit(start_narq_con.2))
## Should not be significant
cox.zph(start_narq_con.2)
testPH_start_narq_con.2 <- ggcoxzph(cox.zph(start_narq_con.2))




start_narq_con.3 <- coxph(Surv(rel_start_d, rel_end_d, event_end) ~ 
                            NARQ_ADM_z + NARQ_RIV_z + sex + age + cluster(session),
                          data = surv_data)
summary(start_narq_con.3)
plot(survfit(start_narq_con.3))
## Should not be significant
cox.zph(start_narq_con.3)
testPH_start_narq_con.3 <- ggcoxzph(cox.zph(start_narq_con.3))
```





# Categorical NARQ
```{r}
#NARQ_scale
median_NARQ_scale = median(surv_data$NARQ_scale, na.rm = T)
surv_data = surv_data %>%
  mutate(NARQ_group = ifelse(NARQ_scale <= median_NARQ_scale, "low", 
                             ifelse(is.na(NARQ_scale), NA, "high")),
         NARQ_group = as.factor(NARQ_group))

#NARQ_ADM
median_NARQ_ADM = median(surv_data$NARQ_ADM, na.rm = T)
surv_data = surv_data %>%
  mutate(NARQ_ADM_group = ifelse(NARQ_ADM <= median_NARQ_ADM, "low", 
                             ifelse(is.na(NARQ_ADM), NA, "high")),
         NARQ_ADM_group = as.factor(NARQ_ADM_group))

#NARQ_RIV
median_NARQ_RIV = median(surv_data$NARQ_RIV, na.rm = T)
surv_data = surv_data %>%
  mutate(NARQ_RIV_group = ifelse(NARQ_RIV <= median_NARQ_RIV, "low", 
                             ifelse(is.na(NARQ_RIV), NA, "high")),
         NARQ_RIV_group = as.factor(NARQ_RIV_group))

```


##Relationship start
- Model 1: rel_entry ~ NARQ_group + cluster(session)
- Model 2: rel_entry ~ NARQ_ADM_group + NARQ_RIV_group + cluster(session)
- Model 3: rel_entry ~ NARQ_ADM_group + NARQ_RIV_group + gender/sex + age + cluster(session)

###Raw NARQ Data
```{r}
start_narq_con.1 <- coxph(Surv(single_start_d, single_end_d, event_start) ~ 
                            NARQ_group + cluster(session), data = surv_data)



summary(start_narq_con.1)
plot(survfit(start_narq_con.1))

## Should not be significant
cox.zph(start_narq_con.1)
testPH_start_narq_con.1 <- ggcoxzph(cox.zph(start_narq_con.1))





start_narq_con.2 <- coxph(Surv(single_start_d, single_end_d, event_start) ~ 
                            NARQ_ADM_group + NARQ_RIV_group + cluster(session), data = surv_data)
summary(start_narq_con.2)
plot(survfit(start_narq_con.2))
## Should not be significant
cox.zph(start_narq_con.2)
testPH_start_narq_con.2 <- ggcoxzph(cox.zph(start_narq_con.2))




start_narq_con.3 <- coxph(Surv(single_start_d, single_end_d, event_start) ~ 
                            NARQ_ADM_group + NARQ_RIV_group + sex + age + cluster(session),
                          data = surv_data)
summary(start_narq_con.3)
plot(survfit(start_narq_con.3))
## Should not be significant
cox.zph(start_narq_con.3)
testPH_start_narq_con.3 <- ggcoxzph(cox.zph(start_narq_con.3))


```



##Relationship end
- Model 1: rel_end ~ NARQ_group + cluster(session)
- Model 2: rel_end ~ NARQ_ADM_group + NARQ_RIV_group + cluster(session)
- Model 3: rel_end ~ NARQ_ADM_group + NARQ_RIV_group + gender/sex + age + cluster(session)

###Raw NARQ Data
```{r}
start_narq_con.1 <- coxph(Surv(rel_start_d, rel_end_d, event_end) ~ 
                            NARQ_group + cluster(session), data = surv_data)



summary(start_narq_con.1)
plot(survfit(start_narq_con.1))

## Should not be significant
cox.zph(start_narq_con.1)
testPH_start_narq_con.1 <- ggcoxzph(cox.zph(start_narq_con.1))





start_narq_con.2 <- coxph(Surv(rel_start_d, rel_end_d, event_end) ~ 
                            NARQ_ADM_group + NARQ_RIV_group + cluster(session), data = surv_data)
summary(start_narq_con.2)
plot(survfit(start_narq_con.2))
## Should not be significant
cox.zph(start_narq_con.2)
testPH_start_narq_con.2 <- ggcoxzph(cox.zph(start_narq_con.2))




start_narq_con.3 <- coxph(Surv(rel_start_d, rel_end_d, event_end) ~ 
                            NARQ_ADM_group + NARQ_RIV_group + sex + age + cluster(session),
                          data = surv_data)
summary(start_narq_con.3)
plot(survfit(start_narq_con.3))
## Should not be significant
cox.zph(start_narq_con.3)
testPH_start_narq_con.3 <- ggcoxzph(cox.zph(start_narq_con.3))
```



#Quartil NARQ
```{r}

#NARQ_scale
NARQ_qu_25 <- quantile(surv_data$NARQ_scale, c(0.25), na.rm = T)
NARQ_qu_50 <- quantile(surv_data$NARQ_scale, c(0.50), na.rm = T)
NARQ_qu_75 <- quantile(surv_data$NARQ_scale, c(0.75), na.rm = T)

surv_data = surv_data %>%
  mutate(NARQ_quartil = ifelse(NARQ_scale <= NARQ_qu_25, 1, 
                            ifelse(NARQ_scale <= NARQ_qu_50 & NARQ_scale > NARQ_qu_25, 2,
                                   ifelse(NARQ_scale <= NARQ_qu_75 & NARQ_scale > NARQ_qu_50, 3,
                                       ifelse(is.na(NARQ_scale), NA, 4)))),
         NARQ_quartil = as.factor(NARQ_quartil))

#NARQ_ADM
ADM_qu_25 <- quantile(surv_data$NARQ_ADM, c(0.25), na.rm = T)
ADM_qu_50 <- quantile(surv_data$NARQ_ADM, c(0.50), na.rm = T)
ADM_qu_75 <- quantile(surv_data$NARQ_ADM, c(0.75), na.rm = T)

surv_data = surv_data %>%
  mutate(NARQ_ADM_quartil = ifelse(NARQ_ADM <= ADM_qu_25, 1, 
                              ifelse(NARQ_ADM <= ADM_qu_50 & NARQ_ADM > ADM_qu_25, 2,
                                   ifelse(NARQ_ADM <= ADM_qu_75 & NARQ_ADM > ADM_qu_50, 3,
                                       ifelse(is.na(NARQ_ADM), NA, 4)))),
         NARQ_ADM_quartil = as.factor(NARQ_ADM_quartil))

#NARQ_RIV
RIV_qu_25 <- quantile(surv_data$NARQ_RIV, c(0.25), na.rm = T)
RIV_qu_50 <- quantile(surv_data$NARQ_RIV, c(0.50), na.rm = T)
RIV_qu_75 <- quantile(surv_data$NARQ_RIV, c(0.75), na.rm = T)

surv_data = surv_data %>%
mutate(NARQ_RIV_quartil = ifelse(NARQ_RIV <= RIV_qu_25, 1, 
                              ifelse(NARQ_RIV <= RIV_qu_50 & NARQ_RIV > RIV_qu_25, 2,
                                   ifelse(NARQ_RIV <= RIV_qu_75 & NARQ_RIV > RIV_qu_50, 3,
                                       ifelse(is.na(NARQ_RIV), NA, 4)))),
         NARQ_RIV_quartil = as.factor(NARQ_RIV_quartil))

```


###Relationship start
- Model 1: rel_entry ~ NARQ_quartil + cluster(session)
- Model 2: rel_entry ~ NARQ_ADM_quartil + NARQ_RIV_quartil + cluster(session)
- Model 3: rel_entry ~ NARQ_ADM_quartil + NARQ_RIV_quartil + gender/sex + age + cluster(session)

####Raw NARQ Data
```{r}
start_narq_con.1 <- coxph(Surv(single_start_d, single_end_d, event_start) ~ 
                            NARQ_quartil + cluster(session), data = surv_data)

summary(start_narq_con.1)
plot(survfit(start_narq_con.1))

## Should not be significant
cox.zph(start_narq_con.1)
testPH_start_narq_con.1 <- ggcoxzph(cox.zph(start_narq_con.1))



start_narq_con.2 <- coxph(Surv(single_start_d, single_end_d, event_start) ~ 
                            NARQ_ADM_quartil + NARQ_RIV_quartil + cluster(session), data = surv_data)
summary(start_narq_con.2)
plot(survfit(start_narq_con.2))
## Should not be significant
cox.zph(start_narq_con.2)
testPH_start_narq_con.2 <- ggcoxzph(cox.zph(start_narq_con.2))




start_narq_con.3 <- coxph(Surv(single_start_d, single_end_d, event_start) ~ 
                            NARQ_ADM_quartil + NARQ_RIV_quartil + sex + age + cluster(session),
                          data = surv_data)
summary(start_narq_con.3)
plot(survfit(start_narq_con.3))
## Should not be significant
cox.zph(start_narq_con.3)
testPH_start_narq_con.3 <- ggcoxzph(cox.zph(start_narq_con.3))


```



###Relationship end
- Model 1: rel_end ~ NARQ_quartil + cluster(session)
- Model 2: rel_end ~ NARQ_ADM_quartil + NARQ_RIV_quartil + cluster(session)
- Model 3: rel_end ~ NARQ_ADM_quartil + NARQ_RIV_quartil + gender/sex + age + cluster(session)

####Raw NARQ Data
```{r}
end_narq_con.1 <- coxph(Surv(rel_start_d, rel_end_d, event_end) ~ 
                            NARQ_quartil + cluster(session), data = surv_data)



summary(end_narq_con.1)
plot(survfit(end_narq_con.1))

## Should not be significant
cox.zph(end_narq_con.1)
testPH_end_narq_con.1 <- ggcoxzph(cox.zph(end_narq_con.1))





end_narq_con.2 <- coxph(Surv(rel_start_d, rel_end_d, event_end) ~ 
                            NARQ_RIV_quartil + NARQ_ADM_quartil + cluster(session), 
                        data = surv_data)
summary(end_narq_con.2)
plot(survfit(end_narq_con.2))
## Should not be significant
cox.zph(end_narq_con.2)
testPH_end_narq_con.2 <- ggcoxzph(cox.zph(end_narq_con.2))




end_narq_con.3 <- coxph(Surv(rel_start_d, rel_end_d, event_end) ~ 
                            NARQ_ADM_quartil + NARQ_RIV_quartil + sex + age + cluster(session),
                          data = surv_data)
summary(end_narq_con.3)
plot(survfit(end_narq_con.3))
## Should not be significant
cox.zph(end_narq_con.3)
testPH_end_narq_con.3 <- ggcoxzph(cox.zph(end_narq_con.3))
```


## Plots
```{r}
##Dichotom
plot_model1 = survfit(Surv(single_start_d, single_end_d, event_start) ~ 
                            NARQ_ADM_group + cluster(session),
                          data = surv_data)
ggsurvplot(plot_model1, data = surv_data, conf.int = T)

plot_model2 = survfit(Surv(rel_start_d, rel_end_d, event_end) ~ 
                            NARQ_ADM_group + NARQ_RIV_group + sex + age + cluster(session),
                          data = surv_data)
ggsurvplot(plot_model2, data = surv_data, conf.int = T)


##Quartil
plot_model3 = survfit(Surv(single_start_d, single_end_d, event_start) ~ 
                            NARQ_ADM_quartil + cluster(session),
                          data = surv_data)
fits <- list(NARQ_ADM_quartil = plot_model3)


ggsurvplot_list(plot_model3, data = surv_data, conf.int = T)
#ggsurvplot(plot_model3, data = surv_data, conf.int = T)


plot_model4 = survfit(Surv(rel_start_d, rel_end_d, event_end) ~ 
                            NARQ_RIV_quartil + cluster(session),
                          data = surv_data)
ggsurvplot(plot_model4, data = surv_data, conf.int = T)

```


##Plot Relative Hazards

Sim1 <- coxsimLinear(M1, b = "AgeMed", Xj = seq(-15, 19, by = 1),
+                      nsim = 100)
```{r}
#install.packages("simPH")
library(simPH)

#Raw
#Erst Surv-Modell berechnen
mod.1 <- coxph(Surv(single_start_d, single_end_d, event_start) ~ 
                            NARQ_scale + cluster(session), data = surv_data)

#Funktion benutzt: Modell, interessante Variable mit "b", Xj = fitted values
Sim1 <- coxsimLinear(mod.1, b = "NARQ_scale", Xj = seq(0, 5, by = 0.5), nsim = 100)
simGG(Sim1)

#z-stand.
mod.2 <- coxph(Surv(single_start_d, single_end_d, event_start) ~ 
                            NARQ_scale_z + cluster(session), data = surv_data)
Sim2 <- coxsimLinear(mod.2, b = "NARQ_scale_z", Xj = seq(-4, 4, by = 0.5), nsim = 100)
simGG(Sim2, xlab = "Units of narcissism from mean in SD", ylab = "Relative Hazards Comparing to Mean")

##ADM
mod.3 <- coxph(Surv(single_start_d, single_end_d, event_start) ~ 
                            NARQ_ADM_z + NARQ_RIV_z + cluster(session), data = surv_data)
Sim3 <- coxsimLinear(mod.3, b = "NARQ_ADM_z", Xj = seq(-4, 4, by = 0.5), nsim = 100)
simGG(Sim3, xlab = "Units of admiration from mean in SD", ylab = "Relative Hazards Comparing to Mean")

Sim3 <- coxsimLinear(mod.3, b = "NARQ_RIV_z", Xj = seq(-4, 4, by = 0.5), nsim = 100)
simGG(Sim3, xlab = "Units of rivalry from mean in SD", ylab = "Relative Hazards Comparing to Mean")


##ADM
mod.3 <- coxph(Surv(single_start_d, single_end_d, event_start) ~ 
                            NARQ_RIV_z + cluster(session), data = surv_data)
Sim3 <- coxsimLinear(mod.3, b = "NARQ_RIV_z", Xj = seq(-4, 4, by = 0.5), nsim = 100)
simGG(Sim3, xlab = "Units of admiration from mean in SD", ylab = "Relative Hazards Comparing to Mean")

##ADM
mod.3 <- coxph(Surv(rel_start_d, rel_end_d, event_end) ~ 
                            NARQ_ADM_z * NARQ_RIV_z + cluster(session), data = surv_data)
sim3 = coxsimInteract(mod.3, b1 = "NARQ_ADM_z", b2 = "NARQ_RIV_z", X2 = seq(-4, 4, by = 1), spin = TRUE)
simGG(sim3, xlab = "Units of rivalry from mean in SD", ylab = "Relative Hazards Comparing to Mean")

Sim3 <- coxsimLinear(mod.3, b = "NARQ_ADM_z", Xj = seq(-4, 4, by = 0.5), nsim = 100)
Sim4 <- coxsimLinear(mod.3, b = "NARQ_RIV_z", Xj = seq(-4, 4, by = 0.5), nsim = 100)



+ simGG(Sim4, xlab = "Units of admiration and rivalry from mean in SD", ylab = "Relative Hazards Comparing to Mean")

Sim3 <- coxsimLinear(mod.3, b = "NARQ_RIV_z", Xj = seq(-4, 4, by = 0.5), nsim = 100)
simGG(Sim3, xlab = "Units of rivalry from mean in SD", ylab = "Relative Hazards Comparing to Mean")

```














```{r}
start_narq_gr.1 <- coxph(Surv(single_start_d, relationship_start_d, event) ~ 
                            NARQ_group + cluster(session), data= surv_data)
summary(start_narq_gr.1)
plot(survfit(start_narq_gr.1))

start_narq_gr.2 <-  coxph(Surv(single_start_d, single_end_d, event) ~ 
                            NARQ_ADM_group + NARQ_RIV_group + cluster(session), data= surv_data)
summary(start_narq_gr.2)
plot(survfit(start_narq_gr.2))

start_narq_gr.3 <-  coxph(Surv(single_start_d, relationship_start_d, event) ~ 
                            NARQ_ADM_group + NARQ_RIV_group + sex + age + cluster(session), data= surv_data)
summary(start_narq_gr.3)
plot(survfit(start_narq_gr.3))
```


