---
title: "02_datawrangling"
author: "Laura Botzet, Sarah Forsthoff, Tanja Gerlach"
date: "20 April 2018"
output: html_document
---

## What to do:
Relationships:
FERTIG  (- für t2: zurückrechnen vom Datum des Ausfüllens zum Beginn der Beziehung --> Tage aus Wochen und Monaten            bestimmen und dann über as.Date zurückrechnen auf Datum des Beziehungsbeginn )
- t2: longformat
- für t2, t3: past relationships und current relationships
- t3: longformat
- t2 & t3 mergen

Alle Informationen zu mergen

## Library
```{r}
# library(jsonlite)
# library(formr)
# library(psych)
# library(stringr)
library(tidyr)
library(dplyr)
```

## Data Import
```{r}
#setwd("C:/Users/q/Desktop/Speicherung/Arbeit/3/Narc_Relationship/narq_relationship_transitions")
#setwd("/Users/sarahforsthoff/Documents/Bachelor Arbeit/Hiwi/narq_relationship_transitions")
# set workingdirectory

pw2015_demographie =  read.csv("ImportedData/pw2015_demographie_select.csv", sep = ";")
pw2015_items = read.csv("ImportedData/pw2015_items_select.csv", sep = ";")
pw2015_t2 = read.csv("ImportedData/pw2015_t2_select.csv", sep = ";")
pw2015_t2_frauen = read.csv("ImportedData/pw2015_t2_frauen_select.csv", sep = ";")
pw2015_t2_ende = read.csv("ImportedData/pw2015_t2_ende_select.csv", sep = ";")
pw2015_t3_start = read.csv("ImportedData/pw2015_t3_start_select.csv", sep = ";")
pw2015_t3_singles = read.csv("ImportedData/pw2015_t3_start_select.csv", sep = ";")
pw2015_t3_relationship_number = read.csv("ImportedData/pw2015_t3_relationship_number_select.csv", sep = ";")
pw2015_t3_partners = read.csv("ImportedData/pw2015_t3_partners_select.csv", sep = ";")
pw2015_t3_mainrelation =
  read.csv("ImportedData/pw2015_t3_mainrelation_select.csv", sep = ";")
pw2015_t3_ende = read.csv("ImportedData/pw2015_t3_ende_select.csv", sep = ";")

```

## Create new data sheet
```{r}
#NARQ
pw2015_demographie[11:28] <-lapply(pw2015_demographie[11:28], as.numeric)
pw2015_demographie <- pw2015_demographie %>% rowwise () %>%  
  mutate("NARQ_ADM" = mean(c(NARQ_7, NARQ_8, NARQ_1, NARQ_18, NARQ_15, NARQ_16, NARQ_2, NARQ_5, NARQ_3), na.rm = TRUE)) %>% 
  mutate("NARQ_RIV" = mean(c(NARQ_17, NARQ_11, NARQ_13, NARQ_6, NARQ_14, NARQ_9, NARQ_10, NARQ_12, NARQ_4), na.rm = TRUE)) %>%
  mutate("NARQ_GESAMT" = mean(c(NARQ_7, NARQ_8, NARQ_1, NARQ_18, NARQ_15, NARQ_16, NARQ_2, NARQ_5, NARQ_3, NARQ_17, NARQ_11,
                              NARQ_13,  NARQ_6, NARQ_14, NARQ_9, NARQ_10, NARQ_12, NARQ_4 ), na.rm = TRUE)) 

#SOI_R
#SOI_R-Skalenwerte erstellen
pw2015_items$SOI_R_6 <- dplyr::recode(pw2015_items$SOI_R_6R, "1"= "7", "2"="6", "3"="5", "4"="4", "5"="3", "6"="2", "7"="1") #Item SOI_R_6R umpolen
pw2015_items[,c(7:15)] <- lapply(pw2015_items[,c(7:15)], as.numeric)
pw2015_items[,c("SOI_R_6")] <- lapply(pw2015_items[,c("SOI_R_6")], as.numeric)
pw2015_items <- pw2015_items %>%  #z-standardisieren, da untersch. Likert-Skalen
  mutate("z_SOI_R_5" = scale(SOI_R_5, center = TRUE, scale = TRUE),"z_SOI_R_6" = scale(SOI_R_6, center = TRUE, scale = TRUE),
         "z_SOI_R_4" = scale(SOI_R_4, center = TRUE, scale = TRUE),"z_SOI_R_1" = scale(SOI_R_1, center = TRUE, scale = TRUE),
         "z_SOI_R_2" = scale(SOI_R_2, center = TRUE, scale = TRUE),"z_SOI_R_3" = scale(SOI_R_3, center = TRUE, scale = TRUE),
         "z_SOI_R_7" = scale(SOI_R_7, center = TRUE, scale = TRUE),"z_SOI_R_8" = scale(SOI_R_8, center = TRUE, scale = TRUE),
         "z_SOI_R_8" = scale(SOI_R_8, center = TRUE, scale = TRUE),"z_SOI_R_9" = scale(SOI_R_9, center = TRUE, scale = TRUE))
pw2015_items <- pw2015_items %>% 
  rowwise() %>% mutate("SOI_R_GESAMT" = mean(c(z_SOI_R_5, z_SOI_R_6, z_SOI_R_4, z_SOI_R_1, z_SOI_R_2, z_SOI_R_3, z_SOI_R_7,
                                               z_SOI_R_8, z_SOI_R_9), na.rm = TRUE))

#longterm items: scale

   pw2015_items[,c(16:25)] <- lapply(pw2015_items[,c(16:25)], as.numeric)
  pw2015_items$longterm_2 <- recode(pw2015_items$longterm_2_R, "1=7; 2=6; 3=5; 4=4; 5=3; 6=2; 7=1")
  pw2015_items$longterm_4_M <- recode(pw2015_items$longterm_4_R_M, "1=7; 2=6; 3=5; 4=4; 5=3; 6=2; 7=1")
  pw2015_items$longterm_4_F <- recode(pw2015_items$longterm_4_R_F, "1=7; 2=6; 3=5; 4=4; 5=3; 6=2; 7=1")
  pw2015_items[,c("longterm_2", "longterm_4_M", "longterm_4_F")] <- lapply(pw2015_items[,c("longterm_2", "longterm_4_M", "longterm_4_F")], as.numeric)
  pw2015_items <- pw2015_items %>%  #z-standardisieren, da untersch. Likert-Skalen
   mutate("z_longterm_1" = scale(longterm_1, center = TRUE, scale = TRUE),"z_longterm_2" = scale(longterm_2, center = TRUE, scale = TRUE),
          "z_longterm_3_M" = scale(longterm_3_M, center = TRUE, scale = TRUE),"z_longterm_3_F" = scale(longterm_3_F, center = TRUE, scale = TRUE),
          "z_longterm_4_M" = scale(longterm_4_M, center = TRUE, scale = TRUE),"z_longterm_4_F" = scale(longterm_4_F, center = TRUE, scale = TRUE),
          "z_longterm_5_M" = scale(longterm_5_M, center = TRUE, scale = TRUE),"z_longterm_5_F" = scale(longterm_5_F, center = TRUE, scale = TRUE),
          "z_longterm_6_M" = scale(longterm_6_M, center = TRUE, scale = TRUE),"z_longterm_7_F" = scale(longterm_7_F, center = TRUE, scale = TRUE))
 
 #Skalenwert Long-Term Orientation
#define items
longterm_items_f <- c("z_longterm_3_F", "z_longterm_4_F", "z_longterm_5_F", "z_longterm_7_F", "z_longterm_1", "z_longterm_2")
longterm_items_m <- c("z_longterm_3_M", "z_longterm_4_M", "z_longterm_5_M", "z_longterm_6_M", "z_longterm_1", "z_longterm_2")
#aggregate to scale
pw2015_items["longterm_f"] <- rowMeans(pw2015_items[,longterm_items_f], na.rm = T)
pw2015_items["longterm_m"] <- rowMeans(pw2015_items[,longterm_items_m], na.rm = T)


#BFI items: scale
###add BFI items to raw data

###long term oriantion (dependent on sex)

```

```{r}
#create selected data sheets

#pw2015_demographie
pw2015_demographie_select <- dplyr::select(pw2015_demographie, session, short_session, sex, age, sex_orientation, attracted_to, occupation, education,sex_orientation, NARQ_GESAMT, NARQ_ADM, NARQ_RIV) 

#pw2015_items
pw2015_items_select <- dplyr:: select(pw2015_items, session, short_session, 
          #number_relationships, end_relationship_years, end_relationship_months, end_relationship_weeks,
          SOI_R_GESAMT, global_interest_LT, global_interest_ST,  longterm_f, longterm_m)

#pw2015_t2_relationships
pw2015_t2_relationship <- left_join(pw2015_t2, pw2015_t2_frauen, by=c("session","short_session"))

pw2015_t2_relationship <- pw2015_t2_relationship %>% mutate(
  "t2_relationship" = derivedVariable(
             "0" = (relationship_f == 1 & relationship_m == 1) | (relationship_f == 1 & is.na(relationship_m) |  
                          (is.na(relationship_f) & relationship_m == 1)),
              "1" = (relationship_f == 2 | relationship_m == 2), .method = "first", .default = 0))

#create relationship duration (unfinished)

pw2015_t2_relationship$ended.x <- as.Date(pw2015_t2_relationship$ended.x)

pw2015_t2_relationship <- pw2015_t2_relationship %>% mutate(
  "relationship1_start_days_m" = relationship1_start_months_m * 30 + relationship1_start_weeks_m * 7,
  "relationship1_start_m" = ended.x - relationship1_start_days_m
  )

pw2015_t2_relationship <- pw2015_t2_relationship %>% mutate(
  "relationship1_start_days_f" = relationship1_start_months_f * 30 + relationship1_start_weeks_f * 7,
  "relationship1_start_f" = ended.y - relationship1_start_days_f
  )

pw2015_t2_relationship <- pw2015_t2_relationship %>% mutate(
  "relationship2_start_days_m" = relationship2_start_months_m * 30 + relationship2_start_weeks_m * 7,
  "relationship2_start_m" = ended.x - relationship2_start_days_m
  )

pw2015_t2_relationship <- pw2015_t2_relationship %>% mutate(
  "relationship2_start_days_f" = relationship2_start_months_f * 30 + relationship2_start_weeks_f * 7,
  "relationship2_start_f" = ended.y - relationship2_start_days_f
  )

pw2015_t2_relationship <- pw2015_t2_relationship %>% mutate(
  "relationship3_start_days_m" = relationship3_start_months_m * 30 + relationship3_start_weeks_m * 7,
  "relationship3_start_m" = ended.x - relationship3_start_days_m
  )

pw2015_t2_relationship <- pw2015_t2_relationship %>% mutate(
  "relationship3_start_days_f" = relationship3_start_months_f * 30 + relationship3_start_weeks_f * 7,
  "relationship3_start_f" = ended.y - relationship3_start_days_f
  )

#convert wide to long format (unfinished)

pw2015_t2_relationship_long <- gather(pw2015_t2_relationship, relationship_count , relationship1:relationship3)

pw2015_t2_relationship_long <- gather(pw2015_t2_relationship_long, relationship_count ,relationship_start_months, relationship1_start_months_m, relationship2_start_months_m, relationship3_start_months_m, relationship1_start_months_f, relationship2_start_months_f, relationship3_start_months_f)

 
Data <- left_join(pw2015_demographie_select, pw2015_items_select, by=c("session","short_session"))


## one longterm variable for "focal" preferred sex,
## based on own sex
Data$longterm_GESAMT <- NA
Data$longterm_GESAMT[Data$sex==1] <- Data$longterm_m[Data$sex==1]
Data$longterm_GESAMT[Data$sex==2] <- Data$longterm_f[Data$sex==2]


```


